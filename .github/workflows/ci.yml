name: CI

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Stage 1: Quick checks (parallel)
  fmt:
    uses: ./.github/workflows/cargo-fmt-nightly.yml

  check:
    uses: ./.github/workflows/cargo-check.yml

  check-simd:
    uses: ./.github/workflows/cargo-check-simd.yml

  check-no-std:
    uses: ./.github/workflows/cargo-check-no-std.yml

  # Stage 2: Linting
  clippy:
    needs: check
    uses: ./.github/workflows/cargo-clippy.yml

  doc:
    needs: check
    uses: ./.github/workflows/cargo-doc.yml

  # Stage 3: Testing
  test:
    needs: clippy
    uses: ./.github/workflows/cargo-test.yml

  test-simd:
    needs: check-simd
    uses: ./.github/workflows/cargo-test-simd.yml

  # Stage 4: Coverage
  coverage:
    needs: test
    uses: ./.github/workflows/coverage.yml
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test-results:
    needs: test
    uses: ./.github/workflows/test-results.yml
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Stage 5: Changelog
  changelog:
    needs: [test, doc]
    uses: ./.github/workflows/changelog.yml
    with:
      enabled: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev') && !contains(github.event.head_commit.message, 'chore') }}

  # Stage 6: Publish
  publish:
    needs: [test, test-simd, coverage]
    uses: ./.github/workflows/publish.yml
    with:
      enabled: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    secrets:
      CRATESIO: ${{ secrets.CRATESIO }}

  # Stage 7: Release
  release:
    needs: [publish, changelog]
    uses: ./.github/workflows/release.yml
    with:
      enabled: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}

  # Final gate
  ci-success:
    if: always()
    needs: [fmt, check, check-simd, check-no-std, clippy, doc, test, test-simd, coverage]
    runs-on: ubuntu-latest
    steps:
      - run: |
          results=("${{ needs.fmt.result }}" "${{ needs.check.result }}" \
                   "${{ needs.check-simd.result }}" "${{ needs.check-no-std.result }}" \
                   "${{ needs.clippy.result }}" "${{ needs.doc.result }}" \
                   "${{ needs.test.result }}" "${{ needs.test-simd.result }}" \
                   "${{ needs.coverage.result }}")
          for r in "${results[@]}"; do
            [[ "$r" != "success" ]] && exit 1
          done

  # Cleanup
  cleanup:
    if: always()
    needs: ci-success
    uses: ./.github/workflows/cleanup.yml
