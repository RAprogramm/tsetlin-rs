name: Release

on:
  workflow_call:
    inputs:
      enabled:
        type: boolean
        required: true

jobs:
  release:
    if: inputs.enabled
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSIONS=$(grep -oP '^## \Kv[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | tac)
          if [ -z "$VERSIONS" ]; then
            echo "No versions found in CHANGELOG.md"
            exit 0
          fi
          echo "Found versions: $(echo $VERSIONS | tr '\n' ' ')"

          for TAG in $VERSIONS; do
            echo "Processing $TAG..."
            if gh release view "$TAG" &>/dev/null; then
              echo "Release $TAG exists, skipping"
              continue
            fi
            NOTES=$(awk -v tag="$TAG" '
              $0 ~ "^## " tag "$" { found=1; next }
              found && /^## v[0-9]/ { exit }
              found { print }
            ' CHANGELOG.md)
            [ -z "$NOTES" ] && NOTES="Release $TAG"
            echo "$NOTES" | gh release create "$TAG" --title "$TAG" --notes-file - --target main --latest=false
            echo "Created $TAG"
          done

          LATEST=$(echo "$VERSIONS" | tail -1)
          [ -n "$LATEST" ] && gh release edit "$LATEST" --latest || true
