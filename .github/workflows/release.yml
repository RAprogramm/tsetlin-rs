name: Release

on:
  workflow_call:
    inputs:
      enabled:
        type: boolean
        required: true

jobs:
  release:
    if: inputs.enabled
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get version from Cargo.toml
          VERSION=$(grep -oP '^version\s*=\s*"\K[^"]+' Cargo.toml)
          TAG="v$VERSION"
          echo "Version: $TAG"

          # Check if release already exists
          if gh release view "$TAG" &>/dev/null; then
            echo "Release $TAG already exists, skipping"
            exit 0
          fi

          # Get squash commit body (last commit on main)
          NOTES=$(git log -1 --pretty=format:"%b" HEAD)

          # Fallback to commit subject if body is empty
          if [ -z "$NOTES" ]; then
            NOTES=$(git log -1 --pretty=format:"%s" HEAD)
          fi

          echo "Release notes:"
          echo "$NOTES"

          # Create release
          echo "$NOTES" | gh release create "$TAG" --title "$TAG" --notes-file - --target main --latest
